<!DOCTYPE html>
<html>
  <head>
    <title>WeighEasy-Mobile-App</title>    
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script data-require="jquery@*" data-semver="2.1.1" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/onsenui/css/onsenui.css">
    <link rel="stylesheet" href="https://unpkg.com/onsenui/css/onsen-css-components.min.css">
    <script src="https://unpkg.com/onsenui/js/onsenui.min.js"></script>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-mobile/1.4.5/jquery.mobile.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-mobile/1.4.5/jquery.mobile.min.css" /> -->
    <!-- FHIR Client JS Library -->
    <script src='./lib/js/jqFhir.js'></script>
  </head>
  <body>
        <ons-page id="pat_demo">
            <ons-toolbar>
                <div class="right">
                    <ons-toolbar-button>
                        <ons-icon icon="ion-navicon, material:md-menu"></ons-icon>
                    </ons-toolbar-button>
                </div>
            </ons-toolbar>
            <ons-list>
                <ons-list-item>
                    <ons-row>
                        <ons-col>Name:</ons-col>
                        <ons-col id='name'></ons-col>
                    </ons-row>
                </ons-list-item>
                <ons-list-item>
                    <ons-row>
                        <ons-col>Gender:</ons-col>
                        <ons-col id='gender'></ons-col>
                    </ons-row>
                </ons-list-item>
                <ons-list-item>
                    <ons-row>
                        <ons-col>Weight:</ons-col>
                        <ons-col id='curweight'></ons-col>
                    </ons-row>
                </ons-list-item>              
                <ons-list-item>
                    <ons-row>
                        <ons-col>MRN</ons-col>
                        <ons-col id='mrn'></ons-col>
                    </ons-row>
                </ons-list-item>              
                <ons-list-item>
                    <ons-row>
                        <ons-col>FIN</ons-col>
                        <ons-col id='fin'></ons-col>
                    </ons-row>
                </ons-list-item>              
                <ons-list-item>
                    <ons-row>
                        <ons-col>Location</ons-col>
                        <ons-col id='location'></ons-col>
                    </ons-row>
                </ons-list-item>              
                <ons-list-item>
                    <ons-row>
                        <ons-col>Visit Reason</ons-col>
                        <ons-col id='vreason'></ons-col>
                    </ons-row>
                </ons-list-item>              
                <ons-list-item>
                    <ons-row>
                        <ons-col>DOB</ons-col>
                        <ons-col id='dob'></ons-col>
                    </ons-row>
                </ons-list-item>
                <ons-list-item>
                    <ons-row>
                        <ons-col>Practitioner</ons-col>
                        <ons-col id='provider'></ons-col>
                    </ons-row>
                </ons-list-item>
            </ons-list>
            <!-- <ons-row>
                <ons-col>Name:</ons-col>
                <ons-col id='name'></ons-col>
            </ons-row>
            <ons-row>
                <ons-col>Gender:</ons-col>
                <ons-col id='gender'></ons-col>
            </ons-row>
            <ons-row>
                <ons-col>Weight:</ons-col>
                <ons-col id='curweight'></ons-col>
            </ons-row> -->
        </ons-page>
        <script type="text/javascript">  
            ons.ready(function() {
                $("ons-toolbar .center").text("Patient Demographics");
            });
            function displayPatient(pt){
                var fullname = '';
                var pt_mrn = '';
                $(pt.name).each(function(name_idx, ptName){
                    if($.type(ptName) !== 'undefined'){
                        if(ptName.use == 'official'){
                            fullname = ptName.given.join(" ") + " " + ptName.family.join(" ");
                        }
                    }
                });
                
                $(pt.identifier).each(function(pt_idx, identifier){
                    if($.type(identifier) !== 'undefined'){
                        if(identifier.system == 'urn:oid:1.1.1.1.1.1'){
                            console.log("Entering MRN section");
                            console.log(identifier.value);
                            $("#mrn").text(identifier.value);
                        }
                    }
                });

                if(fullname != ''){                    
                $("#name").text(fullname);
                }
                else {
                    $("#name").text("anonymous");
                } 
                $("#gender").text(pt.gender);
                console.log(pt.careProvider);
                $(pt.careProvider).each(function(cp_idx, cp){
                    if($.type(cp.reference) !== 'undefined'){
                        $("#provider").text(cp.display);
                    }
                });
            }

            function getObservationResult(ob){
                if ($.type(ob) != 'undefined' &&
                    $.type(ob.valueQuantity) != 'undefined' &&
                    $.type(ob.valueQuantity.value) != 'undefined' &&
                    $.type(ob.valueQuantity.unit) != 'undefined') {
                    return ob.valueQuantity.value + ' ' + ob.valueQuantity.unit;
                } 
                else {
                    return undefined;
                }
            }    

            function setEncounterInfo(enc){  
                $(enc).each(function(enc_idx, encounter){
                    if(encounter.id = "4367906"){
                        console.log(enc);
                        //$("#fin").text(encounter.identifier[0].value);
                    }
                });    
                    //console.log(enc);          
            }        

            // function getBPResult(ob){
            //     //ob.component.forEach(function(bpq, idx) {                    
            //         return ob.component[0].valueQuantity.value;
            //     //});
            // }
          
                FHIR.oauth2.ready(function(smart){
                    smart.patient.read().then(function(pt) {
                        displayPatient (pt);
                    });
                    smart.patient.api.fetchAll({type: 'Encounter'}).then(function(enc){
                        //console.log("Entering Encounter section");
                        setEncounterInfo(enc);
                    });
                    smart.patient.api.fetchAll({type: 'Observation'}).then(function(obv){
                        var byCodes = smart.byCodes(obv, 'code');
                        var bodyWeight = byCodes('29463-7');
                        $("#curweight").text(getObservationResult(bodyWeight[0]))
                        // var bloodPressure = byCodes('55284-4');;
                        // $("#bp").text(getBPResult(bloodPressure[0]));
                    });
                });
        </script>
  </body>
</html>
